<!DOCTYPE html>
<html>
	<head>
		<title>DAW</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
		<style>
			canvas {
				border: 1px solid;
			}
			#editor {
				background-color: #000;
			}
		</style>
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script>
		window.AudioContext = window.AudioContext || window.webkitAudioContext;
		var context = new AudioContext();

		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;

		var buffer = [];
		var sample = new Float32Array();
		var canvas, ctx;
		var visualiser, mic, recorder; // nodes
		var int = null;

		var pos = 0;

		function Float32Concat(first, second)
		{
		    var firstLength = first.length,
		        result = new Float32Array(firstLength + second.length);

		    result.set(first);
		    result.set(second, firstLength);

		    return result;
		}

		function pause() {
			$('#pause-btn').attr('disabled', 'disabled');
			$('#play-btn').removeAttr('disabled');
			$('#record-btn').removeAttr('disabled');

			recorder.disconnect(visualiser);

			int = null;
		}

		var player;

		function play() {
			$('#pause-btn').removeAttr('disabled');
			$('#play-btn').attr('disabled', 'disabled');

			player = context.createBufferSource();

			player.buffer = context.createBuffer(1, sample.length, 44100);
			var ch = player.buffer.getChannelData(0);

			for(var i=0;i<sample.length;i++) {
				ch[i] = sample[i];
			}

			player.connect(visualiser);

			player.start(0);

			player.onended = function() {
				player.disconnect(visualiser);
				pause();
			};
		}

		function record() {
			$('#record-btn').attr('disabled', 'disabled');
			$('#pause-btn').removeAttr('disabled');

			sample = new Float32Array();
			
			recorder.connect(visualiser);

		}

		function init() {

			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');

			editorCanvas = document.getElementById('editor');
			editorContext = editorCanvas.getContext('2d');

			navigator.getUserMedia({audio: true}, function(stream) {

				mic = context.createMediaStreamSource(stream);
				mic.connect(recorder);

				visualiser.connect(context.destination);

			}, function(err) {
				console.log(err);
			});

			visualiser = context.createScriptProcessor(512, 1, 1);

			// update visualiser buffer
			visualiser.onaudioprocess = function(e) {

				buffer = e.inputBuffer.getChannelData(0);
				var output = e.outputBuffer.getChannelData(0);
				for(var i=0;i<512;i++) {
					output[i] = buffer[i];
				}
			}

			recorder = context.createScriptProcessor(2048, 1, 1);
			recorder.onaudioprocess = function(e) {
				var input = e.inputBuffer.getChannelData(0);
				sample = Float32Concat(sample, input);

				var output = e.outputBuffer.getChannelData(0);

				for(var i=0;i<buffer.length;i++) {
					output[i] = input[i];
				}
			}

			ctx.fillStyle = '#F00';
			editorContext.fillStyle = '#FF0';

			int = setInterval(function() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				var h = canvas.height / 2;

				updateEditorView();

				for(var i=0;i<buffer.length;i++) {
					var height = buffer[i] * coef;
					ctx.fillRect(i, h + height, 1, 1);
				}
			}, 1000 / 30);
			
		}

		var coef = 65535 / 200;

		function updateEditorView() {
			// update wave editor

			var m = 0;
			var step = 16;
			editorContext.clearRect(0,0,editorCanvas.width,editorCanvas.height);

			for(var i=0;i<editorCanvas.width * step;i++) {
				var a = coef * sample[sample.length - m] / 10;
				editorContext.fillRect(editorCanvas.width - i, editorCanvas.height / 2 + a, 1, 1);
				m += step;
			}

		}

		$(document).ready(function() {
			init();
		});

		</script>
	</head>
	<body>
		<div class="container">
			<h1>Recorder</h1>
			<div>
				<canvas id="canvas" width="512" height="200"></canvas>
			</div>
			<div>
				<canvas id="editor" width="512" height="100"></canvas>
			</div>
			<div class="form-group">
				<div class="btn-group">
					<button onclick="record()" id="record-btn" class="btn btn-danger">
						<i class="glyphicon glyphicon-record"></i>
					</button>
					<button onclick="pause()" id="pause-btn" disabled="disabled" class="btn btn-success"><i class="glyphicon glyphicon-pause"></i></button>
					<button onclick="play()" id="play-btn" class="btn btn-success"><i class="glyphicon glyphicon-play"></i></button>
				</div>
			</div>
		</div>
	</body>
</html>
