<!DOCTYPE html>
<html>
	<head>
		<title>DAW</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
		<style>
			canvas {
				border: 1px solid;
			}
		</style>
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script>
		window.AudioContext = window.AudioContext || window.webkitAudioContext;
		var context = new AudioContext();

		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;

		var buffer = [];
		var sample = new Float32Array();
		var canvas, ctx;
		var visualiser, mic, recorder, player; // nodes
		var int = null;
		
		var pos = 0;

		function Float32Concat(first, second)
		{
		    var firstLength = first.length,
		        result = new Float32Array(firstLength + second.length);

		    result.set(first);
		    result.set(second, firstLength);

		    return result;
		}

		function pause() {
			$('#pause-btn').attr('disabled', 'disabled');
			$('#play-btn').removeAttr('disabled');
			$('#record-btn').removeAttr('disabled');

			player.disconnect(visualiser);
			recorder.disconnect(visualiser);

			int = null;
		}

		function play() {
			$('#pause-btn').removeAttr('disabled');
			$('#play-btn').attr('disabled', 'disabled');

			player.buffer = context.createBuffer(1, sample.length, 44100);
			var ch = player.buffer.getChannelData(0);

			for(var i=0;i<sample.length;i++) {
				ch[i] = sample[i];
			}

			player.connect(visualiser);

			player.start(0);

			player.onended = pause;
		}

		function record() {
			$('#record-btn').attr('disabled', 'disabled');
			$('#pause-btn').removeAttr('disabled');
			
			recorder.connect(visualiser);

		}

		function init() {

			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');

			navigator.getUserMedia({audio: true}, function(stream) {

				mic = context.createMediaStreamSource(stream);
				mic.connect(recorder);

				visualiser.connect(context.destination);

			}, function(err) {
				console.log(err);
			});

			visualiser = context.createScriptProcessor(512, 1, 1);

			// update visualiser buffer
			visualiser.onaudioprocess = function(e) {

				buffer = e.inputBuffer.getChannelData(0);
				var output = e.outputBuffer.getChannelData(0);
				for(var i=0;i<buffer.length;i++) {
					output[i] = buffer[i];
				}
			}

			recorder = context.createScriptProcessor(1024, 1, 1);
			recorder.onaudioprocess = function(e) {
				var input = e.inputBuffer.getChannelData(0);
				sample = Float32Concat(sample, input);

				var output = e.outputBuffer.getChannelData(0);

				for(var i=0;i<buffer.length;i++) {
					output[i] = input[i];
				}
			}

			player = context.createBufferSource();

			var h = canvas.height / 2;

			int = setInterval(function() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				for(var i=0;i<buffer.length;i+=3) {
					ctx.beginPath();
					ctx.strokeStyle = 'red';
					var height = buffer[i] * 6553.5;
					ctx.moveTo(i, h);
					ctx.lineTo(i, h + height);
					ctx.stroke();
				}
			}, 1000 / 30);
			
		}

		$(document).ready(function() {
			init();
		});

		</script>
	</head>
	<body>
		<div class="container">
			<h1>Recorder</h1>
			<canvas id="canvas" width="512" height="200"></canvas>
			<div>
				<button onclick="record()" id="record-btn" class="btn btn-danger">
					<i class="glyphicon glyphicon-record"></i> Record
				</button>
				<button onclick="pause()" id="pause-btn" disabled="disabled" class="btn"><i class="glyphicon glyphicon-pause"></i> Pause</button>
				<button onclick="play()" id="play-btn" class="btn"><i class="glyphicon glyphicon-play"></i> Play</button>
			</div>
		</div>
	</body>
</html>